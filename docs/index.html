<!DOCTYPE html>

<head>
    <title>typings</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
    <link href="/typings/assets/style.css" rel="stylesheet">
</head>

<body>
    <div id="app">
        <div v-bind:class="themeName">
            <div class="wrapper">
                <div class="main">
                    <div class="text-selector">
                        <div class="text-meter">wpm: {{ wpm }}, acc: {{ acc }}</div>
                        <div class="text-title">
                            typings (beta)
                        </div>
                    </div>
                    <div class="text-main">
                        <div class="text-display" v-html="renderedText"></div>
                        <input type="text" class="text-typing" v-model="curTyping" v-bind:class="[curError ? 'typing-text-wrong' : 'text-typing']" />
                        <a href="#" class="text-restart" @click="restart">Restart</a>
                    </div>
                    <div class="text-themer">
                        <select v-model="themeSelected" @change="selectTheme($event)">
                            <option v-for="theme in themes" v-bind:value="theme.value">
                                {{ theme.name }}
                            </option>
                        </select>
                    </div>
                </div>
            </div>
            <footer class="footer">
                Copyright &copy; <a href="https://crisp.dev"/>David Zhang</a>. <a href="https://github.com/crispgm/typings">View on GitHub</a>.
            </footer>
        </div>
    </div>
</body>

<script type="text/javascript">
    var app = new Vue({
        el: '#app',
        data: {
            themes: [
                {
                    name: 'Minimal',
                    value: 'minimal'
                },
                {
                    name: 'GMK Shoko',
                    value: 'gmk-shoko'
                },
                {
                    name: 'GMK Botanical',
                    value: 'gmk-botanical'
                },
                {
                    name: 'GMK Noel',
                    value: 'gmk-noel'
                },
                {
                    name: 'Nord',
                    value: 'nord'
                }
            ],
            themeName: "theme-minimal",
            themeSelected: 'minimal',
            originalText: 'right world who he on by course without around both so need he just man real end so even these such they may between we in it seem line of back might first to stand become like same little eye way on both by go not early other without feel',
            renderedText: '',
            richTexts: [],
            wpm: 'xxx',
            acc: 'xxx',
            countChoice: 30,
            curTyping: '',
            curIndex: 0,
            curError: false,
            typingCorrectCount: 0,
            typingCount: 0,
            typingStart: null,
            typingEnd: null,
            finished: false
        },
        watch: {
            curTyping: function(val, oldVal) {
                if (this.finished) {
                    return
                }
                if (this.typingStart == null) {
                    this.typingStart = Date.now();
                }
                const curChar = val[val.length-1];
                const curWord = this.richTexts[this.curIndex].text;
                if (this.isPunctuation(curChar)) {
                    if (oldVal == '') {
                        this.curTyping = '';
                        return;
                    }
                    if (curWord == this.curTyping.substr(0, this.curTyping.length-1)) {
                        this.typingCorrectCount++;
                        this.richTexts[this.curIndex].klass = 'typing-text-correct';
                    } else {
                        this.richTexts[this.curIndex].klass = 'typing-text-wrong';
                    }
                    this.typingCount++;
                    this.acc = (this.typingCorrectCount/this.typingCount*100).toFixed(0);
                    this.wpm = (this.typingCount/((Date.now()-this.typingStart)/1000)*60).toFixed(0);
                    if (this.curIndex < this.richTexts.length-1) {
                        this.richTexts[this.curIndex+1].klass = 'typing-text-prepare';
                    } else {
                        this.finished = true;
                    }

                    this.curIndex++;
                    this.curTyping = '';

                    this.render()
                } else {
                    if (curWord.indexOf(this.curTyping) == -1) {
                        this.curError = true;
                    } else {
                        this.curError = false;
                    }
                }
            }
        },
        created: function() {
            this.init();
            this.loadTheme();
        },
        methods: {
            init: function() {
                this.richTexts = [];
                this.loadTexts();
                this.wpm = '---';
                this.acc = '---';
                this.curTyping = '';
                this.curIndex = 0;
                this.typingCorrectCount = 0;
                this.typingCount = 0;
                this.typingStart = null;
                this.typingEnd = null;
                this.render();
            },
            loadTexts: function() {
                const texts = this.originalText.split(' ');
                this.shuffle(texts);
                for (const [index, text] of Object.entries(texts)) {
                    let klass = 'typing-text-normal';
                    if (index == 0) {
                        klass = 'typing-text-prepare';
                    }
                    this.richTexts.push({
                        text,
                        klass
                    });
                }
            },
            render: function() {
                let html = '';
                for (const rt of this.richTexts) {
                    html += `<span class="${rt.klass}">${rt.text}</span> `;
                }
                this.renderedText = html;
            },
            loadTheme: function() {
                const theme = window.localStorage.getItem('theme');
                if (!theme) {
                    theme = 'minimal';
                }
                this.themeName = this.getThemeClass(theme);
            },
            selectTheme: function(event) {
                const themeName = this.getThemeClass(this.themeSelected);
                if (this.themeName == themeName) {
                    return;
                }
                this.themeName = themeName;
                window.localStorage.setItem('theme', this.themeSelected);
            },
            getThemeClass: function(name) {
                return `theme theme-${name}`;
            },
            isPunctuation: function(c) {
                switch (c) {
                case ' ':
                    return true;
                default:
                    return false;
                }
            },
            restart: function() {
                this.init();
            },
            shuffle: function(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * i);
                    const temp = array[i];
                    array[i] = array[j];
                    array[j] = temp;
                }
            }
        }
    })
</script>

</html>
